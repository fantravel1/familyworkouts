---
interface Props {
  text?: string;
  class?: string;
}

const { text = "Celebrate!", class: className = "" } = Astro.props;
---

<button
  type="button"
  class:list={["btn-primary confetti-trigger", className]}
  data-confetti-button
>
  <span class="mr-2">ðŸŽ‰</span>
  {text}
</button>

<script>
  // Simple confetti implementation using canvas
  function createConfetti(x: number, y: number): void {
    const colors = ['#FFD93D', '#FF6B6B', '#4ECDC4', '#9B59B6', '#2ECC71'];
    const confettiCount = 50;

    for (let i = 0; i < confettiCount; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti-piece';
      confetti.style.cssText = `
        position: fixed;
        width: 10px;
        height: 10px;
        background-color: ${colors[Math.floor(Math.random() * colors.length)]};
        left: ${x}px;
        top: ${y}px;
        pointer-events: none;
        z-index: 9999;
        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
        transform: rotate(${Math.random() * 360}deg);
      `;

      document.body.appendChild(confetti);

      const angle = Math.random() * Math.PI * 2;
      const velocity = 5 + Math.random() * 10;
      const vx = Math.cos(angle) * velocity;
      const vy = Math.sin(angle) * velocity - 10;

      let posX = x;
      let posY = y;
      let velX = vx;
      let velY = vy;
      let opacity = 1;

      function animate(): void {
        velY += 0.5; // gravity
        posX += velX;
        posY += velY;
        opacity -= 0.02;

        confetti.style.left = `${posX}px`;
        confetti.style.top = `${posY}px`;
        confetti.style.opacity = String(opacity);

        if (opacity > 0 && posY < window.innerHeight) {
          requestAnimationFrame(animate);
        } else {
          confetti.remove();
        }
      }

      requestAnimationFrame(animate);
    }
  }

  // Attach event listeners
  document.querySelectorAll('[data-confetti-button]').forEach(button => {
    button.addEventListener('click', (e) => {
      const rect = (e.target as HTMLElement).getBoundingClientRect();
      createConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2);
    });
  });

  // Listen for workout completion events
  document.addEventListener('workout-complete', () => {
    createConfetti(window.innerWidth / 2, window.innerHeight / 2);
  });

  // Listen for streak milestones
  document.addEventListener('streak-milestone', () => {
    createConfetti(window.innerWidth / 2, window.innerHeight / 3);
    setTimeout(() => {
      createConfetti(window.innerWidth / 3, window.innerHeight / 2);
    }, 200);
    setTimeout(() => {
      createConfetti(window.innerWidth * 2 / 3, window.innerHeight / 2);
    }, 400);
  });

  // Expose global function
  (window as any).triggerConfetti = createConfetti;
</script>
